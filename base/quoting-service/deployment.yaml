apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: quoting-service
  name: quoting-service
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: quoting-service
  template:
    metadata:
      labels:
        app.kubernetes.io/name: quoting-service
    spec:
      containers:
        - env:
            - name: LOG_LEVEL
              value: info
            - name: LOG_FILTER
              value: error, warn, info
            - name: CSL_LOG_TRANSPORT
              value: console
            - name: EVENT_SDK_LOG_FILTER
              value: audit:*, log:warn, log:error
            - name: EVENT_SDK_SIDECAR_DISABLED
              value: 'true'
            - name: QUOTE_SWITCH_ENDPOINT
              value: centralledger
          image: mojaloop/quoting-service:v9.3.2-snapshot
          imagePullPolicy: Always
          name: quoting-service
          ports:
            - containerPort: 3002
              name: http-api
              protocol: TCP
      initContainers:
        - command:
            - sh
            - -c
            - until result=$(mysql -h "$MYSQL_HOST" -P 3306 -u central_ledger
              --password="$MYSQL_PASSWORD"  central_ledger -ss -N -e 'select is_locked from
              migration_lock;') && eval 'echo is_locked=$result' && if [ -z $result
              ]; then false; fi && if [ $result -ne 0 ]; then false; fi; do echo waiting
              for MySQL; sleep 2; done;
          image: mysql:latest
          imagePullPolicy: Always
          name: wait-for-mysql
          env:
            - name: MYSQL_HOST
              value: cl-mysql
            - name: MYSQL_PASSWORD
              value: oyMxgZChuu
